# PRD-0002: ì¡°ì§ ì „ì²´ ë ˆí¬ PR ìˆ˜ì§‘ ë° Slack List í†µí•©
# ë²„ì „: 1.1
# ì‘ì„±ì¼: 2025-12-23
# ë³€ê²½: 1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰, ìµœê·¼ 5ì¼ í™œë™ ë ˆí¬ë§Œ í•„í„°ë§

name: Organization PR Collection

on:
  # 1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (ë§¤ ì •ì‹œ)
  schedule:
    - cron: '0 * * * *'

  # ìˆ˜ë™ ì‹¤í–‰ íŠ¸ë¦¬ê±°
  workflow_dispatch:
    inputs:
      days_back:
        description: 'ìˆ˜ì§‘í•  ê¸°ê°„ (ì¼)'
        required: false
        default: '5'
        type: string

permissions:
  contents: read

env:
  SLACK_USER_TOKEN: ${{ secrets.SLACK_USER_TOKEN }}
  SLACK_LIST_ID: ${{ secrets.SLACK_LIST_ID }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # garimto81ì€ ê°œì¸ ê³„ì • (users API ì‚¬ìš©)
  OWNER_NAME: 'garimto81'
  IS_ORG: 'false'
  # Column IDs (ì¤‘ì•™ ê´€ë¦¬)
  COL_TITLE: 'Col0A4WG2LPHA'
  COL_PROGRESS: 'Col0A55RYJHEV'
  COL_NOTES: 'Col0A4WG5SFD2'
  COL_DATE: 'Col0A4ZL4THPU'

jobs:
  collect-org-prs:
    runs-on: ubuntu-latest

    outputs:
      json_output: ${{ steps.generate_json.outputs.json_file }}
      total_repos: ${{ steps.collect_repos.outputs.total_repos }}
      total_prs: ${{ steps.collect_prs.outputs.total_prs }}

    steps:
      # Step 1: ìµœê·¼ í™œë™ ìˆëŠ” ë ˆí¬ë§Œ ì¡°íšŒ (ìµœê·¼ 5ì¼ PR ë˜ëŠ” ì´ìŠˆ)
      - name: Collect Active Repositories (Last 5 Days)
        id: collect_repos
        run: |
          echo "=== Collecting active repositories from $OWNER_NAME (last 5 days) ==="

          DAYS_BACK="${{ inputs.days_back || '5' }}"
          SINCE_DATE=$(date -d "$DAYS_BACK days ago" +%Y-%m-%dT%H:%M:%SZ)

          echo "Filtering repos with activity since: $SINCE_DATE"

          # ê°œì¸ ê³„ì • ë˜ëŠ” ì¡°ì§ì— ë”°ë¼ API ë¶„ê¸°
          if [ "$IS_ORG" = "true" ]; then
            API_PATH="orgs/$OWNER_NAME/repos"
          else
            API_PATH="users/$OWNER_NAME/repos?per_page=100"
          fi

          # ë ˆí¬ ëª©ë¡ ì¡°íšŒ (archived ì œì™¸)
          ALL_REPOS=$(gh api "$API_PATH" --jq '[.[] | select(.archived == false) | .name]')

          echo "Total repos: $(echo "$ALL_REPOS" | jq 'length')"

          # í™œë™ ìˆëŠ” ë ˆí¬ë§Œ í•„í„°ë§
          ACTIVE_REPOS="[]"

          for REPO in $(echo "$ALL_REPOS" | jq -r '.[]'); do
            echo -n "Checking: $REPO ... "

            # ìµœê·¼ PR í™•ì¸
            PR_COUNT=$(gh api "repos/$OWNER_NAME/$REPO/pulls?state=all&sort=created&direction=desc&per_page=10" \
              --jq "[.[] | select(.created_at >= \"$SINCE_DATE\")] | length" 2>/dev/null || echo "0")

            # ìµœê·¼ ì´ìŠˆ í™•ì¸
            ISSUE_COUNT=$(gh api "repos/$OWNER_NAME/$REPO/issues?state=all&sort=created&direction=desc&per_page=10" \
              --jq "[.[] | select(.created_at >= \"$SINCE_DATE\" and .pull_request == null)] | length" 2>/dev/null || echo "0")

            if [ "$PR_COUNT" -gt 0 ] || [ "$ISSUE_COUNT" -gt 0 ]; then
              echo "âœ“ Active (PRs: $PR_COUNT, Issues: $ISSUE_COUNT)"
              ACTIVE_REPOS=$(echo "$ACTIVE_REPOS" | jq --arg repo "$REPO" '. += [$repo]')
            else
              echo "skip"
            fi
          done

          TOTAL_REPOS=$(echo "$ACTIVE_REPOS" | jq 'length')
          echo "total_repos=$TOTAL_REPOS" >> $GITHUB_OUTPUT
          # JSONì„ í•œ ì¤„ë¡œ ì••ì¶•í•´ì„œ ì €ì¥ (ë©€í‹°ë¼ì¸ ì˜¤ë¥˜ ë°©ì§€)
          echo "active_repos=$(echo "$ACTIVE_REPOS" | jq -c '.')" >> $GITHUB_OUTPUT

          echo ""
          echo "=== Active repositories: $TOTAL_REPOS ==="
          echo "$ACTIVE_REPOS" | jq -r '.[]'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: í™œì„± ë ˆí¬ì˜ PR ì •ë³´ ìˆ˜ì§‘
      - name: Collect PRs from Active Repositories
        id: collect_prs
        run: |
          echo "=== Collecting PRs from active repositories ==="

          DAYS_BACK="${{ inputs.days_back || '5' }}"
          SINCE_DATE=$(date -d "$DAYS_BACK days ago" +%Y-%m-%dT%H:%M:%SZ)

          # ê²°ê³¼ ì €ì¥í•  ì„ì‹œ íŒŒì¼
          echo '{"repositories": []}' > /tmp/all_prs.json
          TOTAL_PRS=0

          # Step 1ì—ì„œ í•„í„°ë§ëœ í™œì„± ë ˆí¬ ì‚¬ìš©
          REPOS='${{ steps.collect_repos.outputs.active_repos }}'

          # í™œì„± ë ˆí¬ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
          if [ "$(echo "$REPOS" | jq 'length')" -eq 0 ]; then
            echo "No active repositories found. Skipping PR collection."
            echo "total_prs=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          REPOS=$(echo "$REPOS" | jq -r '.[]')

          for REPO in $REPOS; do
            echo "Processing: $REPO"

            # ë¨¸ì§€ëœ PR ì¡°íšŒ
            PRS=$(gh api "repos/$OWNER_NAME/$REPO/pulls?state=closed&sort=updated&direction=desc" \
              --jq "[.[] | select(.merged_at != null and .merged_at >= \"$SINCE_DATE\") | {
                number: .number,
                title: .title,
                merged_at: .merged_at,
                branch: .head.ref
              }]" 2>/dev/null || echo "[]")

            PR_COUNT=$(echo "$PRS" | jq 'length')
            TOTAL_PRS=$((TOTAL_PRS + PR_COUNT))

            if [ "$PR_COUNT" -gt 0 ]; then
              echo "  Found $PR_COUNT merged PRs"

              # PRD IDì™€ Issue ë²ˆí˜¸ ì¶”ì¶œ
              ENRICHED_PRS=$(echo "$PRS" | jq '[.[] | . + {
                prd_id: ((.title | capture("\\[(?<id>PRD-[0-9]+)\\]"; "g") | .id) // (.branch | capture("(?<id>PRD-[0-9]+)"; "g") | .id) // null),
                issue_number: ((.title | capture("#(?<num>[0-9]+)"; "g") | .num | tonumber) // null)
              }]')

              # JSONì— ì¶”ê°€
              REPO_DATA=$(jq -n \
                --arg name "$REPO" \
                --arg url "https://github.com/$OWNER_NAME/$REPO" \
                --argjson prs "$ENRICHED_PRS" \
                '{name: $name, url: $url, prs: $prs}')

              jq --argjson repo "$REPO_DATA" '.repositories += [$repo]' /tmp/all_prs.json > /tmp/temp.json
              mv /tmp/temp.json /tmp/all_prs.json
            fi
          done

          echo "total_prs=$TOTAL_PRS" >> $GITHUB_OUTPUT
          echo "Total PRs collected: $TOTAL_PRS"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 3: Checklist ì •ë³´ ì¶”ê°€ (ê° ë ˆí¬ ì ‘ê·¼) - ì„ íƒì  ë‹¨ê³„
      - name: Enrich with Checklist Data
        id: enrich_checklist
        continue-on-error: true
        run: |
          echo "=== Enriching with checklist data ==="

          REPOS=$(jq -r '.repositories[].name' /tmp/all_prs.json)

          for REPO in $REPOS; do
            echo "Checking checklists in: $REPO"

            # í•´ë‹¹ ë ˆí¬ì˜ PR ì •ë³´ ì¡°íšŒ
            PRS=$(jq -r --arg repo "$REPO" '.repositories[] | select(.name == $repo) | .prs[] | select(.prd_id != null) | "\(.prd_id)"' /tmp/all_prs.json)

            for PRD_ID in $PRS; do
              [ -z "$PRD_ID" ] && continue

              # Checklist ë¬¸ì„œ ì¡°íšŒ ì‹œë„
              CHECKLIST_PATH="docs/checklists/$PRD_ID.md"

              CONTENT=$(gh api "repos/$OWNER_NAME/$REPO/contents/$CHECKLIST_PATH" \
                --jq '.content' 2>/dev/null | base64 -d 2>/dev/null || echo "")

              if [ -n "$CONTENT" ]; then
                # Checklist íŒŒì‹±
                TOTAL=$(echo "$CONTENT" | grep -cE '^\s*-\s*\[[ x]\]' || echo "0")
                DONE=$(echo "$CONTENT" | grep -cE '^\s*-\s*\[x\]' || echo "0")

                if [ "$TOTAL" -gt 0 ]; then
                  PROGRESS=$((DONE * 100 / TOTAL))
                else
                  PROGRESS=0
                fi

                echo "  $PRD_ID: $DONE/$TOTAL ($PROGRESS%)"

                # JSON ì—…ë°ì´íŠ¸
                jq --arg repo "$REPO" --arg prd "$PRD_ID" \
                   --arg path "$CHECKLIST_PATH" \
                   --argjson total "$TOTAL" --argjson done "$DONE" --argjson progress "$PROGRESS" \
                   '(.repositories[] | select(.name == $repo) | .prs[] | select(.prd_id == $prd)) += {
                     checklist: {path: $path, total: $total, completed: $done, progress: $progress}
                   }' /tmp/all_prs.json > /tmp/temp.json
                mv /tmp/temp.json /tmp/all_prs.json
              fi
            done
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 4: ìµœì¢… JSON ìƒì„±
      - name: Generate Final JSON
        id: generate_json
        run: |
          echo "=== Generating final JSON ==="

          COLLECTED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          TOTAL_REPOS=$(jq '.repositories | length' /tmp/all_prs.json)
          TOTAL_PRS=$(jq '[.repositories[].prs | length] | add // 0' /tmp/all_prs.json)

          # ë©”íƒ€ë°ì´í„° ì¶”ê°€
          jq --arg version "1.0" \
             --arg org "$OWNER_NAME" \
             --arg collected_at "$COLLECTED_AT" \
             --argjson total_repos "$TOTAL_REPOS" \
             --argjson total_prs "$TOTAL_PRS" \
             '{
               version: $version,
               metadata: {
                 organization: $org,
                 collected_at: $collected_at,
                 total_repos: $total_repos,
                 total_prs: $total_prs
               },
               repositories: .repositories
             }' /tmp/all_prs.json > /tmp/org-prs.json

          echo "json_file=/tmp/org-prs.json" >> $GITHUB_OUTPUT

          echo "=== Final JSON Summary ==="
          jq '.metadata' /tmp/org-prs.json

      # Step 5: Slack List ì—…ë°ì´íŠ¸
      - name: Update Slack List
        id: update_slack
        run: |
          echo "=== Updating Slack List ==="

          # Column IDsëŠ” envì—ì„œ ê°€ì ¸ì˜´
          TODAY=$(TZ=Asia/Seoul date +%Y-%m-%d)

          # ë ˆí¬ë³„ë¡œ Slack List ì—…ë°ì´íŠ¸
          REPOS=$(jq -r '.repositories[] | @base64' /tmp/org-prs.json)

          for REPO_B64 in $REPOS; do
            REPO=$(echo "$REPO_B64" | base64 -d)
            REPO_NAME=$(echo "$REPO" | jq -r '.name')

            # ì§„í–‰ë¥  ê³„ì‚° (ëª¨ë“  PRì˜ checklist í‰ê· )
            PROGRESS=$(echo "$REPO" | jq '[.prs[].checklist.progress // 0] | add / length | floor // 0')

            # ì»¬ëŸ¬ ì´ëª¨ì§€ í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìƒì„± (slack-list-sync ë°©ì‹ í†µì¼)
            if [ "$PROGRESS" -le 30 ]; then
              STATUS_EMOJI="ğŸ”´"; FILL_BLOCK="ğŸŸ¥"
            elif [ "$PROGRESS" -le 70 ]; then
              STATUS_EMOJI="ğŸŸ¡"; FILL_BLOCK="ğŸŸ¨"
            else
              STATUS_EMOJI="ğŸŸ¢"; FILL_BLOCK="ğŸŸ©"
            fi
            EMPTY_BLOCK="â¬œ"

            FILLED=$((PROGRESS / 10))
            EMPTY=$((10 - FILLED))

            BAR=""
            for i in $(seq 1 $FILLED); do BAR+="$FILL_BLOCK"; done
            for i in $(seq 1 $EMPTY); do BAR+="$EMPTY_BLOCK"; done

            PROGRESS_TEXT="$STATUS_EMOJI $BAR $PROGRESS%"

            # ì§„í–‰ì¤‘ í•­ëª© ëª©ë¡
            PENDING=$(echo "$REPO" | jq -r '[.prs[] | select(.checklist.progress != null and .checklist.progress < 100) | .prd_id] | unique | join(", ")' || echo "")

            echo "Processing: $REPO_NAME ($PROGRESS_TEXT)"

            # ê¸°ì¡´ í•­ëª© ê²€ìƒ‰ (fields ë°©ì‹ìœ¼ë¡œ í†µì¼)
            LIST_RESPONSE=$(curl -s -X POST "https://slack.com/api/slackLists.items.list" \
              -H "Authorization: Bearer $SLACK_USER_TOKEN" \
              -H "Content-Type: application/json; charset=utf-8" \
              -d "{\"list_id\": \"$SLACK_LIST_ID\"}")

            # ì—ëŸ¬ ì²˜ë¦¬
            if [ "$(echo "$LIST_RESPONSE" | jq -r '.ok')" != "true" ]; then
              echo "  ERROR: Failed to list items - $(echo "$LIST_RESPONSE" | jq -r '.error')"
              continue
            fi

            # fields ë°°ì—´ì—ì„œ ì œëª© Columnìœ¼ë¡œ ê²€ìƒ‰ (í†µì¼ëœ ë°©ì‹)
            EXISTING=$(echo "$LIST_RESPONSE" | jq -r --arg name "$REPO_NAME" --arg col "$COL_TITLE" \
              '.items[] | select(.fields[] | select(.column_id == $col) | .text == $name) | .id' | head -1)

            if [ -n "$EXISTING" ] && [ "$EXISTING" != "null" ]; then
              # ì—­í•  ë¶„ë¦¬: ê¸°ì¡´ í•­ëª©ì€ slack-list-syncì—ì„œ ë‹´ë‹¹ - ìŠ¤í‚µ
              echo "  Skipped existing item (managed by slack-list-sync)"
            else
              # ìƒˆ í•­ëª© ìƒì„± (cells ë°©ì‹ìœ¼ë¡œ í†µì¼)
              CREATE_RESPONSE=$(curl -s -X POST "https://slack.com/api/slackLists.items.create" \
                -H "Authorization: Bearer $SLACK_USER_TOKEN" \
                -H "Content-Type: application/json; charset=utf-8" \
                -d "{
                  \"list_id\": \"$SLACK_LIST_ID\",
                  \"item\": {
                    \"fields\": {}
                  }
                }")

              # ì—ëŸ¬ ì²˜ë¦¬
              if [ "$(echo "$CREATE_RESPONSE" | jq -r '.ok')" != "true" ]; then
                echo "  ERROR: Failed to create item - $(echo "$CREATE_RESPONSE" | jq -r '.error')"
                continue
              fi

              NEW_ITEM_ID=$(echo "$CREATE_RESPONSE" | jq -r '.item.id // empty')

              if [ -n "$NEW_ITEM_ID" ]; then
                # ì œëª© ë° ì´ˆê¸° ë°ì´í„° ì„¤ì • (cells ë°©ì‹)
                UPDATE_RESPONSE=$(curl -s -X POST "https://slack.com/api/slackLists.items.update" \
                  -H "Authorization: Bearer $SLACK_USER_TOKEN" \
                  -H "Content-Type: application/json; charset=utf-8" \
                  -d "{
                    \"list_id\": \"$SLACK_LIST_ID\",
                    \"cells\": [
                      {
                        \"row_id\": \"$NEW_ITEM_ID\",
                        \"column_id\": \"$COL_TITLE\",
                        \"rich_text\": [{
                          \"type\": \"rich_text\",
                          \"elements\": [{
                            \"type\": \"rich_text_section\",
                            \"elements\": [{\"type\": \"text\", \"text\": \"$REPO_NAME\"}]
                          }]
                        }]
                      },
                      {
                        \"row_id\": \"$NEW_ITEM_ID\",
                        \"column_id\": \"$COL_PROGRESS\",
                        \"rich_text\": [{
                          \"type\": \"rich_text\",
                          \"elements\": [{
                            \"type\": \"rich_text_section\",
                            \"elements\": [{\"type\": \"text\", \"text\": \"$PROGRESS_TEXT\"}]
                          }]
                        }]
                      },
                      {
                        \"row_id\": \"$NEW_ITEM_ID\",
                        \"column_id\": \"$COL_NOTES\",
                        \"rich_text\": [{
                          \"type\": \"rich_text\",
                          \"elements\": [{
                            \"type\": \"rich_text_section\",
                            \"elements\": [{\"type\": \"text\", \"text\": \"$PENDING\"}]
                          }]
                        }]
                      },
                      {
                        \"row_id\": \"$NEW_ITEM_ID\",
                        \"column_id\": \"$COL_DATE\",
                        \"date\": [\"$TODAY\"]
                      }
                    ]
                  }")

                if [ "$(echo "$UPDATE_RESPONSE" | jq -r '.ok')" != "true" ]; then
                  echo "  WARNING: Item created but update failed - $(echo "$UPDATE_RESPONSE" | jq -r '.error')"
                else
                  echo "  Created new item: $NEW_ITEM_ID"
                fi
              fi
            fi
          done

          echo "=== Slack List update complete ==="

      # Step 6: ê²°ê³¼ ìš”ì•½ ì¶œë ¥
      - name: Summary
        run: |
          echo "## Organization PR Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Owner | $OWNER_NAME |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Repos | ${{ steps.collect_repos.outputs.total_repos }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total PRs | ${{ steps.collect_prs.outputs.total_prs }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Collection Date | $(date -u +%Y-%m-%d) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Repository Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          jq -r '.repositories[] | "- **\(.name)**: \(.prs | length) PRs"' /tmp/org-prs.json >> $GITHUB_STEP_SUMMARY
