# PRD-0002: 조직 전체 레포 PR 수집 및 Slack List 통합
# 버전: 1.1
# 작성일: 2025-12-23
# 변경: 1시간마다 실행, 최근 5일 활동 레포만 필터링

name: Organization PR Collection

on:
  # 1시간마다 실행 (매 정시)
  schedule:
    - cron: '0 * * * *'

  # 수동 실행 트리거
  workflow_dispatch:
    inputs:
      days_back:
        description: '수집할 기간 (일)'
        required: false
        default: '5'
        type: string

permissions:
  contents: read

env:
  SLACK_USER_TOKEN: ${{ secrets.SLACK_USER_TOKEN }}
  SLACK_LIST_ID: ${{ secrets.SLACK_LIST_ID }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # garimto81은 개인 계정 (users API 사용)
  OWNER_NAME: 'garimto81'
  IS_ORG: 'false'

jobs:
  collect-org-prs:
    runs-on: ubuntu-latest

    outputs:
      json_output: ${{ steps.generate_json.outputs.json_file }}
      total_repos: ${{ steps.collect_repos.outputs.total_repos }}
      total_prs: ${{ steps.collect_prs.outputs.total_prs }}

    steps:
      # Step 1: 최근 활동 있는 레포만 조회 (최근 5일 PR 또는 이슈)
      - name: Collect Active Repositories (Last 5 Days)
        id: collect_repos
        run: |
          echo "=== Collecting active repositories from $OWNER_NAME (last 5 days) ==="

          DAYS_BACK="${{ inputs.days_back || '5' }}"
          SINCE_DATE=$(date -d "$DAYS_BACK days ago" +%Y-%m-%dT%H:%M:%SZ)

          echo "Filtering repos with activity since: $SINCE_DATE"

          # 개인 계정 또는 조직에 따라 API 분기
          if [ "$IS_ORG" = "true" ]; then
            API_PATH="orgs/$OWNER_NAME/repos"
          else
            API_PATH="users/$OWNER_NAME/repos?per_page=100"
          fi

          # 레포 목록 조회 (archived 제외)
          ALL_REPOS=$(gh api "$API_PATH" --jq '[.[] | select(.archived == false) | .name]')

          echo "Total repos: $(echo "$ALL_REPOS" | jq 'length')"

          # 활동 있는 레포만 필터링
          ACTIVE_REPOS="[]"

          for REPO in $(echo "$ALL_REPOS" | jq -r '.[]'); do
            echo -n "Checking: $REPO ... "

            # 최근 PR 확인
            PR_COUNT=$(gh api "repos/$OWNER_NAME/$REPO/pulls?state=all&sort=created&direction=desc&per_page=10" \
              --jq "[.[] | select(.created_at >= \"$SINCE_DATE\")] | length" 2>/dev/null || echo "0")

            # 최근 이슈 확인
            ISSUE_COUNT=$(gh api "repos/$OWNER_NAME/$REPO/issues?state=all&sort=created&direction=desc&per_page=10" \
              --jq "[.[] | select(.created_at >= \"$SINCE_DATE\" and .pull_request == null)] | length" 2>/dev/null || echo "0")

            if [ "$PR_COUNT" -gt 0 ] || [ "$ISSUE_COUNT" -gt 0 ]; then
              echo "✓ Active (PRs: $PR_COUNT, Issues: $ISSUE_COUNT)"
              ACTIVE_REPOS=$(echo "$ACTIVE_REPOS" | jq --arg repo "$REPO" '. += [$repo]')
            else
              echo "skip"
            fi
          done

          TOTAL_REPOS=$(echo "$ACTIVE_REPOS" | jq 'length')
          echo "total_repos=$TOTAL_REPOS" >> $GITHUB_OUTPUT
          # JSON을 한 줄로 압축해서 저장 (멀티라인 오류 방지)
          echo "active_repos=$(echo "$ACTIVE_REPOS" | jq -c '.')" >> $GITHUB_OUTPUT

          echo ""
          echo "=== Active repositories: $TOTAL_REPOS ==="
          echo "$ACTIVE_REPOS" | jq -r '.[]'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: 활성 레포의 PR 정보 수집
      - name: Collect PRs from Active Repositories
        id: collect_prs
        run: |
          echo "=== Collecting PRs from active repositories ==="

          DAYS_BACK="${{ inputs.days_back || '5' }}"
          SINCE_DATE=$(date -d "$DAYS_BACK days ago" +%Y-%m-%dT%H:%M:%SZ)

          # 결과 저장할 임시 파일
          echo '{"repositories": []}' > /tmp/all_prs.json
          TOTAL_PRS=0

          # Step 1에서 필터링된 활성 레포 사용
          REPOS='${{ steps.collect_repos.outputs.active_repos }}'

          # 활성 레포가 없으면 종료
          if [ "$(echo "$REPOS" | jq 'length')" -eq 0 ]; then
            echo "No active repositories found. Skipping PR collection."
            echo "total_prs=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          REPOS=$(echo "$REPOS" | jq -r '.[]')

          for REPO in $REPOS; do
            echo "Processing: $REPO"

            # 머지된 PR 조회
            PRS=$(gh api "repos/$OWNER_NAME/$REPO/pulls?state=closed&sort=updated&direction=desc" \
              --jq "[.[] | select(.merged_at != null and .merged_at >= \"$SINCE_DATE\") | {
                number: .number,
                title: .title,
                merged_at: .merged_at,
                branch: .head.ref
              }]" 2>/dev/null || echo "[]")

            PR_COUNT=$(echo "$PRS" | jq 'length')
            TOTAL_PRS=$((TOTAL_PRS + PR_COUNT))

            if [ "$PR_COUNT" -gt 0 ]; then
              echo "  Found $PR_COUNT merged PRs"

              # PRD ID와 Issue 번호 추출
              ENRICHED_PRS=$(echo "$PRS" | jq '[.[] | . + {
                prd_id: ((.title | capture("\\[(?<id>PRD-[0-9]+)\\]"; "g") | .id) // (.branch | capture("(?<id>PRD-[0-9]+)"; "g") | .id) // null),
                issue_number: ((.title | capture("#(?<num>[0-9]+)"; "g") | .num | tonumber) // null)
              }]')

              # JSON에 추가
              REPO_DATA=$(jq -n \
                --arg name "$REPO" \
                --arg url "https://github.com/$OWNER_NAME/$REPO" \
                --argjson prs "$ENRICHED_PRS" \
                '{name: $name, url: $url, prs: $prs}')

              jq --argjson repo "$REPO_DATA" '.repositories += [$repo]' /tmp/all_prs.json > /tmp/temp.json
              mv /tmp/temp.json /tmp/all_prs.json
            fi
          done

          echo "total_prs=$TOTAL_PRS" >> $GITHUB_OUTPUT
          echo "Total PRs collected: $TOTAL_PRS"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 3: Checklist 정보 추가 (각 레포 접근)
      - name: Enrich with Checklist Data
        id: enrich_checklist
        run: |
          echo "=== Enriching with checklist data ==="

          REPOS=$(jq -r '.repositories[].name' /tmp/all_prs.json)

          for REPO in $REPOS; do
            echo "Checking checklists in: $REPO"

            # 해당 레포의 PR 정보 조회
            PRS=$(jq -r --arg repo "$REPO" '.repositories[] | select(.name == $repo) | .prs[] | select(.prd_id != null) | "\(.prd_id)"' /tmp/all_prs.json)

            for PRD_ID in $PRS; do
              [ -z "$PRD_ID" ] && continue

              # Checklist 문서 조회 시도
              CHECKLIST_PATH="docs/checklists/$PRD_ID.md"

              CONTENT=$(gh api "repos/$OWNER_NAME/$REPO/contents/$CHECKLIST_PATH" \
                --jq '.content' 2>/dev/null | base64 -d 2>/dev/null || echo "")

              if [ -n "$CONTENT" ]; then
                # Checklist 파싱
                TOTAL=$(echo "$CONTENT" | grep -cE '^\s*-\s*\[[ x]\]' || echo "0")
                DONE=$(echo "$CONTENT" | grep -cE '^\s*-\s*\[x\]' || echo "0")

                if [ "$TOTAL" -gt 0 ]; then
                  PROGRESS=$((DONE * 100 / TOTAL))
                else
                  PROGRESS=0
                fi

                echo "  $PRD_ID: $DONE/$TOTAL ($PROGRESS%)"

                # JSON 업데이트
                jq --arg repo "$REPO" --arg prd "$PRD_ID" \
                   --arg path "$CHECKLIST_PATH" \
                   --argjson total "$TOTAL" --argjson done "$DONE" --argjson progress "$PROGRESS" \
                   '(.repositories[] | select(.name == $repo) | .prs[] | select(.prd_id == $prd)) += {
                     checklist: {path: $path, total: $total, completed: $done, progress: $progress}
                   }' /tmp/all_prs.json > /tmp/temp.json
                mv /tmp/temp.json /tmp/all_prs.json
              fi
            done
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 4: 최종 JSON 생성
      - name: Generate Final JSON
        id: generate_json
        run: |
          echo "=== Generating final JSON ==="

          COLLECTED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          TOTAL_REPOS=$(jq '.repositories | length' /tmp/all_prs.json)
          TOTAL_PRS=$(jq '[.repositories[].prs | length] | add // 0' /tmp/all_prs.json)

          # 메타데이터 추가
          jq --arg version "1.0" \
             --arg org "$OWNER_NAME" \
             --arg collected_at "$COLLECTED_AT" \
             --argjson total_repos "$TOTAL_REPOS" \
             --argjson total_prs "$TOTAL_PRS" \
             '{
               version: $version,
               metadata: {
                 organization: $org,
                 collected_at: $collected_at,
                 total_repos: $total_repos,
                 total_prs: $total_prs
               },
               repositories: .repositories
             }' /tmp/all_prs.json > /tmp/org-prs.json

          echo "json_file=/tmp/org-prs.json" >> $GITHUB_OUTPUT

          echo "=== Final JSON Summary ==="
          jq '.metadata' /tmp/org-prs.json

      # Step 5: Slack List 업데이트
      - name: Update Slack List
        id: update_slack
        run: |
          echo "=== Updating Slack List ==="

          # Slack List 컬럼 ID (기존 설정 사용)
          COL_TITLE="Col0A4WG2LPHA"
          COL_PROGRESS="Col0A55RYJHEV"
          COL_NOTES="Col0A4WG5SFD2"
          COL_DATE="Col0A4ZL4THPU"

          TODAY=$(TZ=Asia/Seoul date +%Y-%m-%d)

          # 레포별로 Slack List 업데이트
          REPOS=$(jq -r '.repositories[] | @base64' /tmp/org-prs.json)

          for REPO_B64 in $REPOS; do
            REPO=$(echo "$REPO_B64" | base64 -d)
            REPO_NAME=$(echo "$REPO" | jq -r '.name')

            # 진행률 계산 (모든 PR의 checklist 평균)
            PROGRESS=$(echo "$REPO" | jq '[.prs[].checklist.progress // 0] | add / length | floor // 0')

            # 프로그레스 바 생성
            FILLED=$((PROGRESS / 10))
            EMPTY=$((10 - FILLED))
            BAR=$(printf '█%.0s' $(seq 1 $FILLED 2>/dev/null) || echo "")$(printf '░%.0s' $(seq 1 $EMPTY 2>/dev/null) || echo "░░░░░░░░░░")
            PROGRESS_TEXT="$BAR $PROGRESS%"

            # 진행중 항목 목록
            PENDING=$(echo "$REPO" | jq -r '[.prs[] | select(.checklist.progress != null and .checklist.progress < 100) | .prd_id] | unique | join(", ")' || echo "")

            echo "Updating: $REPO_NAME ($PROGRESS_TEXT)"

            # 기존 항목 검색
            EXISTING=$(curl -s -X POST "https://slack.com/api/slackLists.items.list" \
              -H "Authorization: Bearer $SLACK_USER_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"list_id\": \"$SLACK_LIST_ID\"}" | \
              jq -r --arg name "$REPO_NAME" '.items[] | select(.values[$COL_TITLE].text_value == $name) | .id' 2>/dev/null || echo "")

            if [ -n "$EXISTING" ] && [ "$EXISTING" != "null" ]; then
              # 기존 항목 업데이트
              curl -s -X POST "https://slack.com/api/slackLists.items.update" \
                -H "Authorization: Bearer $SLACK_USER_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{
                  \"list_id\": \"$SLACK_LIST_ID\",
                  \"item_id\": \"$EXISTING\",
                  \"values\": {
                    \"$COL_PROGRESS\": {\"text_value\": \"$PROGRESS_TEXT\"},
                    \"$COL_NOTES\": {\"text_value\": \"$PENDING\"},
                    \"$COL_DATE\": {\"date_value\": \"$TODAY\"}
                  }
                }" > /dev/null
              echo "  Updated existing item"
            else
              # 새 항목 생성
              curl -s -X POST "https://slack.com/api/slackLists.items.create" \
                -H "Authorization: Bearer $SLACK_USER_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{
                  \"list_id\": \"$SLACK_LIST_ID\",
                  \"values\": {
                    \"$COL_TITLE\": {\"text_value\": \"$REPO_NAME\"},
                    \"$COL_PROGRESS\": {\"text_value\": \"$PROGRESS_TEXT\"},
                    \"$COL_NOTES\": {\"text_value\": \"$PENDING\"},
                    \"$COL_DATE\": {\"date_value\": \"$TODAY\"}
                  }
                }" > /dev/null
              echo "  Created new item"
            fi
          done

          echo "=== Slack List update complete ==="

      # Step 6: 결과 요약 출력
      - name: Summary
        run: |
          echo "## Organization PR Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Owner | $OWNER_NAME |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Repos | ${{ steps.collect_repos.outputs.total_repos }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total PRs | ${{ steps.collect_prs.outputs.total_prs }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Collection Date | $(date -u +%Y-%m-%d) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Repository Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          jq -r '.repositories[] | "- **\(.name)**: \(.prs | length) PRs"' /tmp/org-prs.json >> $GITHUB_STEP_SUMMARY
