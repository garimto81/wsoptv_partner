name: Slack List Sync

on:
  pull_request:
    types: [closed]

permissions:
  contents: write  # Checklist ìë™ ì²´í¬ ì»¤ë°‹ìš©

env:
  SLACK_USER_TOKEN: ${{ secrets.SLACK_USER_TOKEN }}
  SLACK_LIST_ID: ${{ secrets.SLACK_LIST_ID }}

jobs:
  update-slack-list:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      # Step 0: Checkout (Checklist ë¬¸ì„œ ì ‘ê·¼ í•„ìš”)
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 1: PRD ID, Issue ë²ˆí˜¸, ë ˆí¬ ì´ë¦„ ì¶”ì¶œ
      - name: Extract PRD ID, Issue Number, and Repo Name
        id: extract_ids
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          BRANCH_NAME="${{ github.head_ref }}"
          PR_NUM="${{ github.event.pull_request.number }}"
          FULL_REPO="${{ github.repository }}"
          PR_BODY=$(cat << 'EOFBODY'
          ${{ github.event.pull_request.body }}
          EOFBODY
          )

          # 0. ë ˆí¬ ì´ë¦„ ì¶”ì¶œ (owner ì œê±°)
          REPO_NAME=$(echo "$FULL_REPO" | cut -d'/' -f2)

          # 1. PRD ID ì¶”ì¶œ (ìš°ì„ ìˆœìœ„: ì œëª© > ë¸Œëœì¹˜ > ë³¸ë¬¸)
          PRD_ID=""

          # PR ì œëª©ì—ì„œ [PRD-NNNN] ì¶”ì¶œ
          PRD_ID=$(echo "$PR_TITLE" | grep -oE '\[PRD-[0-9]+\]' | tr -d '[]' | head -1)

          # ì—†ìœ¼ë©´ ë¸Œëœì¹˜ëª…ì—ì„œ PRD-NNNN ì¶”ì¶œ
          if [ -z "$PRD_ID" ]; then
            PRD_ID=$(echo "$BRANCH_NAME" | grep -oE 'PRD-[0-9]+' | head -1)
          fi

          # ì—†ìœ¼ë©´ PR ë³¸ë¬¸ì—ì„œ Checklist: ë¼ì¸ íŒŒì‹±
          if [ -z "$PRD_ID" ]; then
            PRD_ID=$(echo "$PR_BODY" | grep -oE 'Checklist:.*PRD-[0-9]+' | grep -oE 'PRD-[0-9]+' | head -1)
          fi

          # 2. Issue ë²ˆí˜¸ ì¶”ì¶œ (ê¸°ì¡´ ë¡œì§)
          ISSUE_NUM=$(echo "$PR_TITLE" | grep -oE '#[0-9]+' | head -1 | tr -d '#')
          if [ -z "$ISSUE_NUM" ]; then
            ISSUE_NUM=$(echo "$BRANCH_NAME" | grep -oE '[0-9]+' | head -1)
          fi

          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "prd_id=$PRD_ID" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT

          echo "Repository: $REPO_NAME"
          echo "Extracted PRD ID: $PRD_ID"
          echo "Extracted Issue Number: $ISSUE_NUM"
          echo "PR Number: $PR_NUM"

      # Step 2: Checklist ë¬¸ì„œ ê²½ë¡œ íƒìƒ‰
      - name: Find Checklist Document
        id: find_checklist
        run: |
          PRD_ID="${{ steps.extract_ids.outputs.prd_id }}"
          CHECKLIST_PATH=""
          SOURCE="none"

          if [ -n "$PRD_ID" ]; then
            PRD_NUM=$(echo "$PRD_ID" | grep -oE '[0-9]+')

            # ìš°ì„ ìˆœìœ„ 1: docs/checklists/PRD-NNNN.md
            if [ -f "docs/checklists/$PRD_ID.md" ]; then
              CHECKLIST_PATH="docs/checklists/$PRD_ID.md"
              SOURCE="document"
            # ìš°ì„ ìˆœìœ„ 2: tasks/prds/NNNN-prd-*.md
            elif ls tasks/prds/${PRD_NUM}-prd-*.md 1>/dev/null 2>&1; then
              CHECKLIST_PATH=$(ls tasks/prds/${PRD_NUM}-prd-*.md | head -1)
              SOURCE="document"
            # ìš°ì„ ìˆœìœ„ 3: docs/PRD-NNNN-*.md
            elif ls docs/$PRD_ID-*.md 1>/dev/null 2>&1; then
              CHECKLIST_PATH=$(ls docs/$PRD_ID-*.md | head -1)
              SOURCE="document"
            # ìš°ì„ ìˆœìœ„ 4: docs/CHECKLIST.md
            elif [ -f "docs/CHECKLIST.md" ]; then
              CHECKLIST_PATH="docs/CHECKLIST.md"
              SOURCE="document"
            fi
          fi

          echo "checklist_path=$CHECKLIST_PATH" >> $GITHUB_OUTPUT
          echo "source=$SOURCE" >> $GITHUB_OUTPUT
          echo "Found Checklist: $CHECKLIST_PATH (source: $SOURCE)"

      # Step 3: Checklist ë¬¸ì„œ íŒŒì‹± (ë¬¸ì„œê°€ ìˆì„ ë•Œ)
      - name: Parse Checklist Document
        id: parse_doc
        if: steps.find_checklist.outputs.source == 'document'
        run: |
          CHECKLIST_PATH="${{ steps.find_checklist.outputs.checklist_path }}"

          # ë¦¬ìŠ¤íŠ¸ í˜•ì‹ (- [ ]) + í…Œì´ë¸” í˜•ì‹ (| [ ] |) ëª¨ë‘ ì§€ì›
          TOTAL=$(grep -cE '^\s*[-|]\s*\[[ xX]\]' "$CHECKLIST_PATH" 2>/dev/null || echo 0)
          DONE=$(grep -cE '^\s*[-|]\s*\[[xX]\]' "$CHECKLIST_PATH" 2>/dev/null || echo 0)

          if [ "$TOTAL" -gt 0 ]; then
            PROGRESS=$((DONE * 100 / TOTAL))
          else
            PROGRESS=100
          fi

          # ì§„í–‰ì¤‘ í•­ëª© ì¶”ì¶œ (ìµœëŒ€ 5ê°œ)
          PENDING=$(grep -E '^\s*[-|]\s*\[ \]' "$CHECKLIST_PATH" 2>/dev/null | sed 's/^\s*[-|]\s*\[ \]\s*/â€¢ /' | head -5)
          PENDING_COUNT=$(grep -cE '^\s*[-|]\s*\[ \]' "$CHECKLIST_PATH" 2>/dev/null || echo 0)

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "done=$DONE" >> $GITHUB_OUTPUT
          echo "progress=$PROGRESS" >> $GITHUB_OUTPUT
          echo "pending_count=$PENDING_COUNT" >> $GITHUB_OUTPUT
          {
            echo 'pending<<EOF'
            echo "$PENDING"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          echo "Document Parsing: $DONE/$TOTAL ($PROGRESS%)"

      # Step 4: PR ë³¸ë¬¸ Checklist íŒŒì‹± (Fallback)
      - name: Parse PR Body Checklist (Fallback)
        id: parse_pr
        if: steps.find_checklist.outputs.source != 'document'
        run: |
          PR_BODY=$(cat << 'EOFBODY'
          ${{ github.event.pull_request.body }}
          EOFBODY
          )

          TOTAL=$(echo "$PR_BODY" | grep -cE '^\s*-\s*\[[ xX]\]' || echo 0)
          DONE=$(echo "$PR_BODY" | grep -cE '^\s*-\s*\[[xX]\]' || echo 0)

          if [ "$TOTAL" -gt 0 ]; then
            PROGRESS=$((DONE * 100 / TOTAL))
          else
            PROGRESS=100
          fi

          PENDING=$(echo "$PR_BODY" | grep -E '^\s*-\s*\[ \]' | sed 's/^\s*-\s*\[ \]\s*/â€¢ /' | head -5)
          PENDING_COUNT=$(echo "$PR_BODY" | grep -cE '^\s*-\s*\[ \]' || echo 0)

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "done=$DONE" >> $GITHUB_OUTPUT
          echo "progress=$PROGRESS" >> $GITHUB_OUTPUT
          echo "pending_count=$PENDING_COUNT" >> $GITHUB_OUTPUT
          {
            echo 'pending<<EOF'
            echo "$PENDING"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          echo "PR Body Parsing (Fallback): $DONE/$TOTAL ($PROGRESS%)"

      # Step 5: ìë™ ì²´í¬ - Issue ë²ˆí˜¸ ë§¤ì¹­ í•­ëª© ì—…ë°ì´íŠ¸
      - name: Auto-check Matching Items
        id: auto_check
        if: steps.find_checklist.outputs.source == 'document'
        run: |
          # Issue ë²ˆí˜¸ ì‚¬ìš© (PR ì œëª©/ë¸Œëœì¹˜ì—ì„œ ì¶”ì¶œëœ ë²ˆí˜¸)
          ISSUE_NUM="${{ steps.extract_ids.outputs.issue_number }}"
          CHECKLIST_PATH="${{ steps.find_checklist.outputs.checklist_path }}"

          echo "Auto-checking items with Issue #$ISSUE_NUM in $CHECKLIST_PATH"

          if [ -n "$ISSUE_NUM" ]; then
            # Issue ë²ˆí˜¸ì™€ ë§¤ì¹­ë˜ëŠ” ë¯¸ì™„ë£Œ í•­ëª© ì²´í¬
            # ë¦¬ìŠ¤íŠ¸ í˜•ì‹: - [ ] í•­ëª© (#123)
            sed -i "s/- \[ \] \(.*\)(#$ISSUE_NUM)/- [x] \1(#$ISSUE_NUM)/g" "$CHECKLIST_PATH"

            # í…Œì´ë¸” í˜•ì‹: | [ ] | í•­ëª© | #123 |
            sed -i "s/| \[ \] |/| [x] |/g" "$CHECKLIST_PATH"
          fi

          # ë³€ê²½ í™•ì¸
          if git diff --quiet "$CHECKLIST_PATH"; then
            echo "updated=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "Changes detected, will commit"
          fi

      # Step 6: ë³€ê²½ëœ Checklist ì»¤ë°‹
      - name: Commit Checklist Updates
        if: steps.auto_check.outputs.updated == 'true'
        run: |
          CHECKLIST_PATH="${{ steps.find_checklist.outputs.checklist_path }}"
          ISSUE_NUM="${{ steps.extract_ids.outputs.issue_number }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$CHECKLIST_PATH"
          git commit -m "chore: auto-check checklist for #$ISSUE_NUM

          Generated with [Claude Code](https://claude.ai/code)"

          git push

          echo "Committed checklist update for #$ISSUE_NUM"

      # Step 7: ìµœì¢… ì§„í–‰ë¥  ê³„ì‚° (ìë™ ì²´í¬ í›„ ì¬íŒŒì‹±)
      - name: Calculate Final Progress
        id: final_progress
        run: |
          SOURCE="${{ steps.find_checklist.outputs.source }}"
          CHECKLIST_PATH="${{ steps.find_checklist.outputs.checklist_path }}"

          if [ "$SOURCE" == "document" ] && [ -n "$CHECKLIST_PATH" ]; then
            # ìë™ ì²´í¬ í›„ ì¬íŒŒì‹±
            TOTAL=$(grep -cE '^\s*[-|]\s*\[[ xX]\]' "$CHECKLIST_PATH" 2>/dev/null || echo 0)
            DONE=$(grep -cE '^\s*[-|]\s*\[[xX]\]' "$CHECKLIST_PATH" 2>/dev/null || echo 0)

            if [ "$TOTAL" -gt 0 ]; then
              PROGRESS=$((DONE * 100 / TOTAL))
            else
              PROGRESS=100
            fi

            PENDING=$(grep -E '^\s*[-|]\s*\[ \]' "$CHECKLIST_PATH" 2>/dev/null | sed 's/^\s*[-|]\s*\[ \]\s*/â€¢ /' | head -5)
            PENDING_COUNT=$(grep -cE '^\s*[-|]\s*\[ \]' "$CHECKLIST_PATH" 2>/dev/null || echo 0)
          else
            # Fallback ê²°ê³¼ ì‚¬ìš©
            TOTAL="${{ steps.parse_pr.outputs.total }}"
            DONE="${{ steps.parse_pr.outputs.done }}"
            PROGRESS="${{ steps.parse_pr.outputs.progress }}"
            PENDING_COUNT="${{ steps.parse_pr.outputs.pending_count }}"
            PENDING=$(cat << 'EOFPENDING'
          ${{ steps.parse_pr.outputs.pending }}
          EOFPENDING
          )
          fi

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "done=$DONE" >> $GITHUB_OUTPUT
          echo "progress=$PROGRESS" >> $GITHUB_OUTPUT
          echo "pending_count=$PENDING_COUNT" >> $GITHUB_OUTPUT
          {
            echo 'pending<<EOF'
            echo "$PENDING"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          echo "Final Progress: $DONE/$TOTAL ($PROGRESS%)"

      # Step 8: Slack List Item ì¡°íšŒ (ë ˆí¬ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰)
      - name: Get Slack List Item ID
        id: get_item
        run: |
          RESPONSE=$(curl -s -X POST "https://slack.com/api/slackLists.items.list" \
            -H "Authorization: Bearer $SLACK_USER_TOKEN" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "list_id=$SLACK_LIST_ID")

          REPO_NAME="${{ steps.extract_ids.outputs.repo_name }}"

          # ì œëª© Column (Col0A4WG2LPHA)ì—ì„œ ë ˆí¬ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰
          ITEM_ID=$(echo "$RESPONSE" | jq -r --arg repo "$REPO_NAME" \
            '.items[] | select(
              .fields[] | select(.column_id == "Col0A4WG2LPHA") | .text == $repo
            ) | .id' | head -1)

          echo "item_id=$ITEM_ID" >> $GITHUB_OUTPUT
          echo "Found item for repo '$REPO_NAME': $ITEM_ID"

      # Step 9: Slack List Item ìƒì„± (ì—†ì„ ê²½ìš°)
      - name: Create Slack List Item (if not exists)
        id: create_item
        if: steps.get_item.outputs.item_id == ''
        run: |
          REPO_NAME="${{ steps.extract_ids.outputs.repo_name }}"

          # í•­ëª© ìƒì„±
          RESPONSE=$(curl -s -X POST "https://slack.com/api/slackLists.items.create" \
            -H "Authorization: Bearer $SLACK_USER_TOKEN" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "{
              \"list_id\": \"$SLACK_LIST_ID\",
              \"item\": {
                \"fields\": {}
              }
            }")

          echo "API Response: $RESPONSE"

          NEW_ITEM_ID=$(echo "$RESPONSE" | jq -r '.item.id // empty')

          # ì œëª© Columnì— ë ˆí¬ ì´ë¦„ ì„¤ì •
          if [ -n "$NEW_ITEM_ID" ]; then
            curl -s -X POST "https://slack.com/api/slackLists.items.update" \
              -H "Authorization: Bearer $SLACK_USER_TOKEN" \
              -H "Content-Type: application/json; charset=utf-8" \
              -d "{
                \"list_id\": \"$SLACK_LIST_ID\",
                \"cells\": [{
                  \"row_id\": \"$NEW_ITEM_ID\",
                  \"column_id\": \"Col0A4WG2LPHA\",
                  \"rich_text\": [{
                    \"type\": \"rich_text\",
                    \"elements\": [{
                      \"type\": \"rich_text_section\",
                      \"elements\": [{
                        \"type\": \"text\",
                        \"text\": \"$REPO_NAME\"
                      }]
                    }]
                  }]
                }]
              }"
          fi

          echo "item_id=$NEW_ITEM_ID" >> $GITHUB_OUTPUT
          echo "Created new item for repo '$REPO_NAME': $NEW_ITEM_ID"

      # Step 10: í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìƒì„±
      - name: Build Progress Bar
        id: progress_bar
        run: |
          PROGRESS="${{ steps.final_progress.outputs.progress }}"
          TOTAL="${{ steps.final_progress.outputs.total }}"
          DONE="${{ steps.final_progress.outputs.done }}"
          PENDING_COUNT="${{ steps.final_progress.outputs.pending_count }}"

          # Checklistê°€ ìˆëŠ” ê²½ìš°ë§Œ í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìƒì„±
          if [ "$TOTAL" -gt 0 ]; then
            # 10ì¹¸ í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìƒì„±
            FILLED=$((PROGRESS / 10))
            EMPTY=$((10 - FILLED))

            BAR=""
            for i in $(seq 1 $FILLED); do BAR+="â–ˆ"; done
            for i in $(seq 1 $EMPTY); do BAR+="â–‘"; done

            PROGRESS_BAR="$BAR $PROGRESS% ($DONE/$TOTAL)"

            # ë¹„ê³  í•„ë“œìš© í…ìŠ¤íŠ¸ (ì§„í–‰ì¤‘ì¸ í•­ëª©ë§Œ)
            if [ "$PENDING_COUNT" -eq 0 ]; then
              NOTE_TEXT="âœ… ëª¨ë‘ ì™„ë£Œ!"
            else
              PENDING_ITEMS=$(cat << 'EOFPENDING'
          ${{ steps.final_progress.outputs.pending }}
          EOFPENDING
          )
              if [ "$PENDING_COUNT" -gt 5 ]; then
                EXTRA=$((PENDING_COUNT - 5))
                NOTE_TEXT="ğŸ”„ ì§„í–‰ì¤‘:\n$PENDING_ITEMS\nâ€¢ ì™¸ ${EXTRA}ê°œ"
              else
                NOTE_TEXT="ğŸ”„ ì§„í–‰ì¤‘:\n$PENDING_ITEMS"
              fi
            fi
          else
            # Checklist ë¯¸ì‘ì„± ì‹œ N/A í‘œì‹œ
            PROGRESS_BAR="N/A"
            PR_TITLE="${{ steps.extract_ids.outputs.pr_title }}"
            NOTE_TEXT="ğŸ“ $PR_TITLE"
          fi

          echo "progress_bar=$PROGRESS_BAR" >> $GITHUB_OUTPUT
          {
            echo 'note<<EOF'
            echo "$NOTE_TEXT"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      # Step 10.5: í˜„ì¬ ë‚ ì§œ ìƒì„± (KST)
      - name: Get Current Date (KST)
        id: current_date
        run: |
          # KST (Asia/Seoul) ê¸°ì¤€ ë‚ ì§œ
          CURRENT_DATE=$(TZ=Asia/Seoul date +"%Y-%m-%d")
          echo "date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "Current date (KST): $CURRENT_DATE"

      # Step 11: Slack List ì—…ë°ì´íŠ¸
      - name: Update Slack List Item
        if: steps.get_item.outputs.item_id != '' || steps.create_item.outputs.item_id != ''
        run: |
          # ê¸°ì¡´ í•­ëª© ë˜ëŠ” ìƒˆë¡œ ìƒì„±ëœ í•­ëª© ID ì‚¬ìš©
          ITEM_ID="${{ steps.get_item.outputs.item_id }}"
          if [ -z "$ITEM_ID" ]; then
            ITEM_ID="${{ steps.create_item.outputs.item_id }}"
          fi

          # ì§„í–‰ë¥  í•„ë“œìš© í”„ë¡œê·¸ë ˆìŠ¤ ë°”
          PROGRESS_BAR="${{ steps.progress_bar.outputs.progress_bar }}"

          # ë¹„ê³  í•„ë“œ ë‚´ìš© êµ¬ì„±
          NOTE_TEXT=$(cat << 'EOFNOTE'
          ${{ steps.progress_bar.outputs.note }}
          EOFNOTE
          )

          # JSON ì´ìŠ¤ì¼€ì´í”„ (ì¤„ë°”ê¿ˆ, ë”°ì˜´í‘œ)
          NOTE_JSON=$(echo "$NOTE_TEXT" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

          # í˜„ì¬ ë‚ ì§œ (KST)
          CURRENT_DATE="${{ steps.current_date.outputs.date }}"

          # ì§„í–‰ë¥ (í”„ë¡œê·¸ë ˆìŠ¤ ë°”) + ë¹„ê³ (ì§„í–‰ì¤‘ í•­ëª©) + ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì—…ë°ì´íŠ¸
          curl -s -X POST "https://slack.com/api/slackLists.items.update" \
            -H "Authorization: Bearer $SLACK_USER_TOKEN" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "{
              \"list_id\": \"$SLACK_LIST_ID\",
              \"cells\": [
                {
                  \"row_id\": \"$ITEM_ID\",
                  \"column_id\": \"Col0A55RYJHEV\",
                  \"rich_text\": [{
                    \"type\": \"rich_text\",
                    \"elements\": [{
                      \"type\": \"rich_text_section\",
                      \"elements\": [{
                        \"type\": \"text\",
                        \"text\": \"$PROGRESS_BAR\"
                      }]
                    }]
                  }]
                },
                {
                  \"row_id\": \"$ITEM_ID\",
                  \"column_id\": \"Col0A4WG5SFD2\",
                  \"rich_text\": [{
                    \"type\": \"rich_text\",
                    \"elements\": [{
                      \"type\": \"rich_text_section\",
                      \"elements\": [{
                        \"type\": \"text\",
                        \"text\": \"$NOTE_JSON\"
                      }]
                    }]
                  }]
                },
                {
                  \"row_id\": \"$ITEM_ID\",
                  \"column_id\": \"Col0A4ZL4THPU\",
                  \"date\": [\"$CURRENT_DATE\"]
                }
              ]
            }"
